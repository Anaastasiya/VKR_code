<!DOCTYPE html>
<html lang="ru">
<head>
 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey=d79f15bd-be5c-4169-9324-7b1a47288075" type="text/javascript"></script>
    <script src="polylineEditor.js" type="text/javascript"></script>
    <title>Выбор пунктов</title>
    <style>
      html, body, #map {
        width: 50%; height: 50%; padding: 0; margin: 0;
    }
        form {
            width: 80%;
            margin: auto;
        }
        label, input, select {
            display: block;
            margin: 10px;
        }
        input[type=submit] {
            width: 100px;
        }
        
    </style>
</head>
<body>
 <div id="map"></div>
    <h1>Выберите пункты отправления и прибытия</h1>
    <form action="/results" method="GET">
        <!-- <label for="country">Страна:</label>
        <select id="country" name="country" required>
            <option value="">Выберите страну</option>
            {% for country in countries %}
            <option value="{{ country['codes']['yandex_code'] }}">{{ country['title'] }}</option>
            {% endfor %}
        </select> -->
        <label for="country">Страна:</label>
        <select id="country" name="country" required>
            <option value="">Выберите страну</option>
            {% for country in countries %}
            
            <option value="{{ country.codes.yandex_code }}">{{country.codes.yandex_code}} : {{country.title }}</option>
            {% endfor %}
        
        
          </select>

          <label for="stations">Станция:</label>
        <input type = "text" id="stations" name="stations" required>
            <option value="">Выберите станцию</option>
          </input>
          <ul id="suggestions"></ul>

        <label for="from">Откуда:</label>
        <select id="from" name="from" required>
            <option value="">Выберите станцию</option>
        </select>
        <label for="to">Куда:</label>
        <select id="to" name="to" required>
            <option value="">Выберите станцию</option>
        </select>
        <label for="date">Дата:</label>
        <input type="date" id="date" name="date" value="{{ today }}" min="{{ today }}" max="{{ max_date }}" required>
        <input type="submit" value="Поиск">
    </form>
    <table id="table">
    </table>
    <div class="copyright__data">Данные предоставлены сервисом Яндекс.Расписания</div>
    <!-- Добавляем скрипт JavaScript для заполнения списков станций -->
   
    <!-- Добавляем скрипт JavaScript для заполнения списков станций -->
    <script>
      // Получаем элементы выпадающих списков по их id
      var countrySelect = document.getElementById("country");
      var fromSelect = document.getElementById("from");
      var toSelect = document.getElementById("to");
      var inputField = document.getElementById("stations");
      var ulField = document.getElementById("suggestions");
      var stations;
      // Добавляем обработчик события на изменение ввода
      inputField.addEventListener("input", changeAutoComplete);
      // Добавляем обработчик события изменения значения выбранной страны
      countrySelect.addEventListener("change", function() {
        // Получаем код выбранной страны из атрибута value элемента option
        var countryCode = countrySelect.value;
        console.log("countryCode: "+countryCode);
        // Если код страны не пустой, то отправляем AJAX-запрос к маршруту /stations для получения списка станций по этой стране
        if (countryCode) {

          // Создаем объект XMLHttpRequest для отправки асинхронного запроса
          var xhr = new XMLHttpRequest();
          // Задаем параметры запроса: метод GET, адрес маршрута /stations с параметром country_code, асинхронность true
          xhr.open("GET", "/stations?country_code=" + countryCode, true);

          // Добавляем обработчик события загрузки ответа от сервера
          xhr.onload = function() {
            // Если статус ответа равен 200 (успешно), то обрабатываем данные из ответа в формате JSON 
            if (xhr.status === 200) {
              // Парсим данные из ответа в формате JSON и получаем массив stations 
              stations = JSON.parse(xhr.responseText);

              console.log(stations)

              
              // Очищаем содержимое выпадающих списков для выбора станций 
              //fromSelect.innerHTML = "";
              //toSelect.innerHTML = "";
              // Добавляем первый элемент option с пустым значением и текстом "Выберите станцию" в каждый список 
              //var firstOptionFrom = document.createElement("option");
              //firstOptionFrom.value = "";
              //firstOptionFrom.textContent = "Выберите станцию";
              //fromSelect.appendChild(firstOptionFrom);
              //var firstOptionTo = document.createElement("option");
              //firstOptionTo.value = "";
              //firstOptionTo.textContent = "Выберите станцию";
              //toSelect.appendChild(firstOptionTo);
              // Проходим по массиву stations и добавляем элементы option с кодом и названием станции в каждый список
              //for (var i = 0; i < stations.length; i++) {
          //var station = stations[i];
          //var optionFrom = document.createElement("option");
          //optionFrom.value = station.code;
          //optionFrom.textContent = station.title;
          //fromSelect.appendChild(optionFrom);
          //var optionTo = document.createElement("option");
          //optionTo.value = station.code;
          //optionTo.textContent = station.title;
          //toSelect.appendChild(optionTo);
        //}
      }
      else {
        // Если статус ответа не равен 200 (ошибка), то выводим сообщение об ошибке в консоль браузера
        console.error("Ошибка при получении списка станций: " + xhr.status);
      }
    };
    // Отправляем запрос к серверу
    xhr.send();
  }

  else {
    // Если код страны пустой, то очищаем содержимое выпадающих списков для выбора станций
    fromSelect.innerHTML = "";
    toSelect.innerHTML = "";
  }
});
// Функция для изменения автозаполнения
function changeAutoComplete({ target }) {
  // Получаем значение введенное пользователем
  let data = target.value;

  // Очищаем список от предыдущих значений
  ulField.innerHTML = "";

  // Если ввод не пустой, то ищем подходящие станции
  if (data.length) {
    // Создаем массив для хранения найденных станций
    let autoCompleteValues = [];

    // Перебираем все ключи словаря станций
    for (let key of Object.keys(stations)) {
      // Если ключ начинается с введенного значения, то добавляем его в массив
      if (key.toLowerCase().startsWith(data.toLowerCase())) {
        console.log(key);
        autoCompleteValues.push(key);
      }
    }

    // Если массив не пустой, то создаем элементы списка для каждого значения
    if (autoCompleteValues.length) {
      for (let value of autoCompleteValues) {
        // Создаем элемент li с текстом значения и атрибутом data-city со значением города
        let li = document.createElement("li");
        li.textContent = value;
        li.setAttribute("data-city", stations[value]);

        // Добавляем элемент в список
        ulField.appendChild(li);
      }
    }
  }
}

// Функция для выбора элемента из списка
function selectItem({ target }) {
  // Если кликнули по элементу li, то заполняем поле ввода его текстом и выводим город в консоль
  if (target.tagName === "LI") {
    inputField.value = target.textContent;
    console.log(target.getAttribute("data-city"));
  }
}

// Добавляем обработчик события отправки формы
document.querySelector("form").addEventListener("submit", function(event) {
  // Отменяем действие по умолчанию (перезагрузку страницы)
  event.preventDefault();
  // Получаем значения выбранных станций и даты из элементов формы
  var fromCode = fromSelect.value;
  var toCode = toSelect.value;
  var date = document.getElementById("date").value;
  // Если все значения не пустые, то отправляем AJAX-запрос к маршруту /results для получения списка поездов по этим параметрам
  if (fromCode && toCode && date) {
    // Создаем объект XMLHttpRequest для отправки асинхронного запроса
    var xhr = new XMLHttpRequest();
    // Задаем параметры запроса: метод GET, адрес маршрута /results с параметрами from, to и date, асинхронность true
    xhr.open("GET", "/results?from=" + fromCode + "&to=" + toCode + "&date=" + date, true);
    // Добавляем обработчик события загрузки ответа от сервера
    xhr.onload = function() {
      // Если статус ответа равен 200 (успешно), то обрабатываем данные из ответа в формате JSON 
      if (xhr.status === 200) {
        // Парсим данные из ответа в формате JSON и получаем массив trains 
        var trains = JSON.parse(xhr.responseText);
        // Получаем элемент таблицы по его id
        console.log(trains)
        var table = document.getElementById("table");
        // Очищаем содержимое таблицы 
        table.innerHTML = "";
        // Добавляем первую строку таблицы с заголовками столбцов 
        var headerRow = document.createElement("tr");
        var headerCells = ["Номер поезда", "Отправление", "Прибытие", "Время в пути"];
        for (var i = 0; i < headerCells.length; i++) {
          var headerCell = document.createElement("th");
          headerCell.textContent = headerCells[i];
          headerRow.appendChild(headerCell);
        }
        table.appendChild(headerRow);
        // Проходим по массиву trains и добавляем строки таблицы с данными о поездах 
        for (var i = 0; i < trains.length; i++) {
          var train = trains[i];
          var row = document.createElement("tr");
          var cells = [train.thread.number, train.departure, train.arrival, train.duration];
          for (var j = 0; j < cells.length; j++) {
            var cell = document.createElement("td");
            cell.textContent = cells[j];
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }
      else {
        // Если статус ответа не равен 200 (ошибка), то выводим сообщение об ошибке в консоль браузера
        console.error("Ошибка при получении списка поездов: " + xhr.status);
      }
    };
    // Отправляем запрос к серверу
    xhr.send();
  }
});
</script>




</html>
